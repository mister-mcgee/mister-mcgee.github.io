---
import Card from "@components/learn/lesson/Card";
import Cards from "@components/learn/lesson/Cards";
import Drawer from "@layouts/Drawer.astro";
import Layout from "@layouts/Layout.astro";
import { Hash } from "@lucide/astro";
import { getCollection, type CollectionEntry } from "astro:content";
import { LibraryBig } from "lucide-react";

export async function getStaticPaths() {
  return (await getCollection("lessons")).reduce((tags, idea) => {
    idea.data.tags?.forEach(tag => {
      if(!tags.includes(tag)) tags.push(tag)
    })
    return tags
  }, new Array<string>()).map(tag => ({
    params: { tag }
  }))
}

const { tag } = Astro.params

type Lesson = CollectionEntry<"lessons">;

function compare(a: Lesson, b: Lesson) {
  let k;
  if ((k = compareCourse(a, b)) !== 0) return k;
  if ((k = compareDate  (a, b)) !== 0) return k;
  if ((k = compareTitle (a, b)) !== 0) return k;
  return compareId(a, b);
}

function compareCourse(a: Lesson, b: Lesson) {
  if (a.data.course && b.data.course)
    return a.data.course.localeCompare(b.data.course);
  else if (a.data.course && !b.data.course)
    return -1;
  else if (!a.data.course && b.data.course)
    return  1;
  else 
    return  0;
}

function compareTitle(a: Lesson, b: Lesson) {
  if (a.data.title && b.data.title)
    return a.data.title.localeCompare(b.data.title);
  else if (a.data.title && !b.data.title)
    return -1;
  else if (!a.data.title && b.data.title)
    return  1;
  else 
    return  0;
}

function compareDate(a: Lesson, b: Lesson) {
  if (a.data.date && b.data.date)
    return a.data.date != b.data.date ? a.data.date < b.data.date ? -1 : 1 : 0;
  else if (a.data.date && !b.data.date)
    return -1;
  else if (!a.data.date && b.data.date)
    return  1;
  else 
    return  0;
}

function compareId(a: Lesson, b: Lesson) {
  return a.id.localeCompare(b.id);
}

function slug(lesson: Lesson) {
  return lesson.filePath
    ?.replace(/^src\/learn\//, "")
    ?.replace(      /\.mdx?$/, "");
}

function plain(lesson: Lesson) {
  return {
    title  : lesson.data.title  ,
    course : lesson.data.course ,
    author : lesson.data.author ,
    tags   : lesson.data.tags   ,
    date   : lesson.data.date   ,
    draft  : lesson.data.draft  ,
    slug   : slug(lesson)       ,
  } as const
}

const lessons = (await getCollection("lessons"))
  .filter(lesson => lesson.data.tags?.includes(tag))
  .sort(compare)
  .map (plain  )

---

<Layout>
  <Drawer>
    <div class="flex flex-col w-full h-full items-center">
      <div class="h-4"></div>
      <div class="flex flex-row gap-1">
        <Hash class="w-10 h-10"/>
        <span class="text-4xl font-bold">{ tag }</span>
      </div>      
      <div class="h-4"></div>
      <div class="w-fit grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-4 p-8">
        { <Cards client:load lessons={lessons}/> }
      </div>

      <div class="flex flex-row gap-4">
        <a href="/learn/tag" class="grow-on-hover grow flex gap-2 items-center justify-center border border-base-300 rounded-lg shadow-lg overflow-hidden cursor-pointer w-sm p-8">
          <Hash/>
          <span>More Tags</span>
        </a>

        <a href="/learn" class="grow-on-hover grow flex gap-2 items-center justify-center border border-base-300 rounded-lg shadow-lg overflow-hidden cursor-pointer w-sm p-8">
          <LibraryBig/>
          <span>More Lessons</span>
        </a>
      </div>
      
    </div>
  </Drawer>
</Layout>